# 第5周周记 - 2026-02-12

**日期：** 2026年2月12日  
**主题：** 项目环境初始化与依赖管理

---

## 本周工作概述

这周主要完成了项目的基础环境搭建，把之前零散的配置统一规范了。包括 Git 仓库初始化、依赖版本锁定，以及 UV 虚拟环境的建立。目标是让环境配置可复现，方便后续在内网机器上部署。

---

## 具体工作内容

### 1. Git 仓库初始化

把项目做成了 Git 仓库，但还没设远端。现在可以在本地做版本管理了，后续如果推到公司 GitLab 再加 remote。

**相关文件：**
- `.git/` - 新初始化的仓库
- 当前无远端配置

### 2. 依赖管理规范化

对照 `one_model` 仓库的风格，把依赖声明统一成了固定版本格式（`==` 而不是 `>=`）。

**具体改动：**
- `requirements.txt`：从松散约束改成精确版本锁定
- `setup.py`：`install_requires` 同步更新
- `pyproject.toml`：`project.dependencies` 同步更新

**版本列表（共15个）：**
- torch==2.0.0
- torchvision==0.15.0  
- numpy==1.21.0
- pillow==9.0.0
- tqdm==4.65.0
- plyfile==0.8.0
- imageio==2.9.0
- imageio-ffmpeg==0.4.0
- lpips==0.1.4
- scikit-learn==1.0.0
- scipy==1.7.0
- tensorboard==2.10.0
- matplotlib==3.5.0
- trimesh==3.15.0（可选但推荐）
- open3d==0.16.0（可选但推荐）

### 3. UV 虚拟环境搭建

用 UV 重建了虚拟环境，指定 Python 3.10（因为之前默认建出来是 3.13，很多老包不支持）。

**环境信息：**
- 环境路径：`.venv/`
- Python 版本：3.10.19
- 管理工具：uv 0.9.9
- 激活命令：`source .venv/bin/activate`

**注：** 目前环境是空的（未安装任何包），方便后续从内网源完整安装。

### 4. 内网源配置准备

确认了公司内网 PyPI 源的使用方式：
- 源地址：`http://artifactory.intra.xiaojukeji.com/artifactory/api/pypi/pypi/simple`
- 安装时需要加 `--trusted-host` 参数

### 5. Kaggle Pipeline 跑通（复线记录）

由于公司实验机环境依赖受限，本周临时切到 Kaggle 验证最小可用流水线，目标是先完成 `train -> render -> metrics` 的闭环。

**Kaggle 环境快照：**
- Python 3.12.12
- GPU: Tesla P100 16GB
- Torch: 2.8.0+cu126
- nvcc: 12.5

**复线步骤（已验证）：**
1. 克隆仓库到 `/kaggle/working/gaussian-splatting`
2. 不直接安装 `requirements.txt`（与 Kaggle 的 Python 3.12 + torch 2.8 存在版本冲突）
3. 安装最小依赖：`plyfile pillow tqdm imageio imageio-ffmpeg tensorboard lpips`
4. 下载 `nerf_example_data.zip` 并解压到 `/kaggle/working/data/nerf_synthetic/lego`
5. 针对 P100 显存做临时降配补丁：
   - `scene/dataset_readers.py`：`target_num_pts` 降到 `3_000`
   - `utils/camera_utils.py`：额外下采样到 `orig / (resolution_scale * 8)`
   - `train.py`：`except RuntimeError` 改为 `except (RuntimeError, ValueError)`，规避 event 计时兼容问题
6. 删除旧点云缓存：`/kaggle/working/data/nerf_synthetic/lego/points3d.ply`
7. 训练命令（100 iter smoke test）：
   - `--sh_degree 0`
   - `--densify_until_iter 0`
   - `--white_background --eval`
8. 渲染命令必须带 `-s` 和 `--eval`，否则 test 集为空
9. 指标计算后输出 `results_100.json`

**跑通结果：**
- 输出目录：`/kaggle/working/runs/lego_tiny_100`
- 指标文件：`/kaggle/working/runs/lego_tiny_100/results_100.json`
- 指标（200 张 test 图）：
  - PSNR: 9.6484
  - SSIM: 0.6200
  - LPIPS: 0.6304

**关键踩坑总结：**
1. `Could not recognize scene type!`：`-s` 路径必须直接包含 `transforms_train.json`（或 `sparse/`）
2. 初始化 OOM：100k 随机点 + `torch.cdist` 会爆显存，需先降 `target_num_pts`
3. 渲染 OOM：当前仓库是 PyTorch fallback rasterizer，必须降分辨率和点数
4. `AssertionError` in `load_ply`：训练和渲染的 `--sh_degree` 必须一致
5. `No images found`：`render.py` 需带 `--eval` 才会有 test set 输出

---

## 遇到的问题与思考

1. **版本兼容问题**  
   一开始 UV 默认建了 Python 3.13 的环境，但 torch==2.0.0 这些老版本不支持 3.13，只能降到 3.10。这说明锁定老版本依赖的同时也要注意 Python 版本上限。

2. **依赖同步维护**  
   这个项目同时有 `requirements.txt`、`setup.py`、`pyproject.toml` 三处声明，之前各自为政容易不一致。现在统一成一样的内容，但后续如果修改要记得三处一起改。

3. **内网 vs 开源源**  
   看了下 `one_model` 的 requirements，里面有很多 `@ file:///...` 的本地路径，这种在其他机器装不了。我们现在的方案是保持可移植的版本号格式，安装时再指定内网源，两边都能用。

4. **运行时和依赖锁定的冲突**  
   本项目当前依赖锁定是按 Python 3.10 + torch 2.0 设计的，而 Kaggle 默认是 Python 3.12 + torch 2.8。为了先跑通流水线，Kaggle 侧采用“最小依赖安装 + 运行时补丁”的策略，后续需要单独维护 notebook 运行配置。

---

## 下周计划

1. **形成稳定 baseline**  
   在 Kaggle 侧将训练迭代从 100 提升到 1000，记录指标变化，建立可比较基线。

2. **整理可复线 Notebook**  
   把本周验证通过的命令整理成固定 cell 顺序，减少手工改动。

3. **评估加速路径**  
   对比当前 PyTorch fallback 与 CUDA rasterizer 的可用性，确认后续性能优化路线。

---

## 技术备忘

```bash
# UV 环境操作
uv venv --python 3.10 .venv              # 创建/重建环境
source .venv/bin/activate                # 激活环境
uv run python xxx.py                     # 不激活直接运行（推荐）

# 内网源安装（待执行）
uv pip install -r requirements.txt \
  --index-url http://artifactory.intra.xiaojukeji.com/artifactory/api/pypi/pypi/simple \
  --allow-insecure-host artifactory.intra.xiaojukeji.com
```
